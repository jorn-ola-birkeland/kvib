import { Meta } from "@storybook/addon-docs";
import { Alert, AlertIcon } from "@kvib/react/src/alert";
import { KvibProvider } from "@kvib/react/src/provider/KvibProvider";

<Meta title="Bidra" />

# Guidelines for bidragsl√∏ypa

## Byggel√∏ype for en komponent

### Generelt üìå

- Legg til oppgave i [KOMP Boardet i Jira](https://kartverket.atlassian.net/jira/software/projects/KOMP/boards/80) n√•r du skal implementere, oppdatere, style, fikse en komponent eller andre oppgaver relatert til designsystemet. Pass p√• √• holde oppgaven oppdatert; b√•de hvor den er i prosessen og evt. dokumentasjon.
  **Sjekk om det allerede finnes en liknende ooppgave f√∏r du legger inn egen.**
- Mapper navngis med sm√• bokstaver
- .ts-filer navngis med sm√• bokstaver, alle andre filer navngis med stor forbokstav. Eksempelvis vil det bli: link.ts og Link.tsx.
- Alle gjeldende props til en komponent skal dokumenteres i Kvib, og ikke bare de props‚Äôene vi definerer selv. Dette gj√∏res av to grunner:
- Enklere for brukere; de trenger bare √• forholde seg til en nettside.
- I tilfeller hvor vi har fjernet/endret p√• props‚Äôene til Chakra vil det v√¶re misvisende √• henvise til Chakra sin dokumentasjon.
- For √• tydeliggj√∏re hvilke komponenter som er kvibifisert, skal vi i dokumentasjonen benytte ‚Äú\*\*‚Äù ved siden av komponentnanvet i Storybook filstrukturen.

### Bygge komponenten üõ†

Under f√∏lger en beskrivelse av hvordan en komponent kan bygges.
I de fleste tilfeller inneb√¶rer dette bare √• justere p√• props, men i enkelte tilfeller kan det v√¶re √∏nskelig √• bygge selve react-komponenten litt annerledes enn Chakra har gjort.
Link-komponenten brukes som eksempel under.

1.  I `packages/react/src`: finn mappen med navnet p√• komponenten, dvs link.
2.  I denne mappen (`packages/react/src/link`) lag √©n fil, _Link.tsx_ (i tillegg til _index.tsx_ som ligger der fra f√∏r).
    _Link.tsx_ skal brukes for √• kvibifisere komponenten med f.eks. egne props, og index.tsx brukes for √• eksportere alt fra _.tsx_-filen.
3.  I _Link.tsx_: Begynn med √• definere hvilke props som skal v√¶re gjeldende for din komponent, samt hvilke typer hver prop kan ta. Dette kan gj√∏res p√• to m√•ter:

- **Alternativ 1- bygg p√• Chakras props**: Importer Chakra sine props (her; LinkProps), og fjern un√∏dvendige props og legg evt. til egndefinerte props.
  Du m√• ogs√• definere en prop fra Chakra p√• nytt dersom du skal endre p√• hvilke verdier denne propen kan ta.
  I koden under har vi fjernet chakra sin egen `variant`, og heller lagt til v√•r egendefinerte `variant` som kun tar verdiene ‚Äúgreen‚Äù og ‚Äúblue‚Äù.

      ```jsx
      import {LinkProps as ChakraLinkProps} from "@chakra-ui/react";

      export type LinkProps = Omit<ChakraLinkProps, "variant">
      & {colorScheme: "green" | "blue"; };

      ```

- **Alternativ 2- definer egne props fra bunnen**: Her m√• man definere alle props fra bunnen av.

  ````jsx
  export type LinkProps = {
    colorScheme?: "green" | "blue", //denne er ikke required pga. "?"
    href: string, //denne er required. Kommer feilmelding dersom denne ikke settes i komponenten.
    children?: string,
  };
        ```
  ````

{" "}

<br />
<KvibProvider>
  <Alert status="info">
    <AlertIcon />
    _required_ props er ikke det samme som √• sette default. Eksempelvis colorScheme er ikke required fordi man √∏nsker ikke
    at brukeren m√• sette colorScheme dersom hen vil ha default-verdien. Hvordan sette default-verdi kommer i senere steg
    i denne guiden.
  </Alert>
</KvibProvider>

4.  Videre i _Link.tsx_ skal du bygge opp komponenten ved √• bruke propsa du definerte i steg 3. De propsene du endrer p√• sendes manuelt videre til Chakra-komponenten, de andre kan videresendes ved √• bruke _‚Äú‚Ä¶props‚Äù_- syntaksen.
    Ved √• tilegne props verdier settes default for komponenten, noe som m√• gj√∏res dersom propsen er satt som required.

{" "}

<KvibProvider>
  <Alert status="info">
    <AlertIcon />
    Under [‚ÄúStyle komponenten‚Äù](/docs/bidra--docs#style-komponenten-) nevnes defaultProps som en del av .ts-filen. Default
    som settes i selve komponenten i.tsx-filen overkj√∏rer defaultPropsa som settes i styling .ts-filen.
  </Alert>
</KvibProvider>

        <br/>

5.  Flere av Chakra-komponentene har en litt annen variant for √• kunne opprettes. Disse komponentene kan opprettes med funksjonen _forwardRef(props, ref)_ fra `@chakra-ui/react`.
    I tillegg til √• ta imot _props_, tas det ogs√• imot en _ref_, som refererer til det underliggende html-element brukt i komponenten.
    _ref_ skal sendes uendret videre til den underliggende Chakra-komponenten (se eksempelet under).
    P√• denne m√•ten kan man manipulere DOM-en direkte, for eksempel for √• flytte fokus til et element (dette har ikke react innebygget st√∏tte for).
    Mer informasjon om forwardRef finner du p√• [forwardRef-react](https://react.dev/reference/react/forwardRef)
    og [The as prop and Custom component](https://chakra-ui.com/community/recipes/as-prop).

    ````jsx
    export const Link = forwardRef<LinkProps, "a">(({ children, colorScheme = "green", ...props }, ref) => {
      const isExternal = props.isExternal !== undefined ? props.isExternal : Boolean(props.href?.match(/^https?:\/\//));
      return (
        <ChakraLink {...props} ref={ref} colorScheme={colorScheme} isExternal={isExternal}>
          {children}
          {isExternal && (
            <span
              className="material-symbols-rounded"
              style={{ fontSize: "18px", verticalAlign: "middle", marginLeft: "4px" }}
              aria-label="Ekstern lenke"
            >
              launch
            </span>
          )}
        </ChakraLink>
      );
    });
    ```

    ````

6.  Tilslutt; eksporter alt fra _Link.tsx_ i _index.tsx_, og fjern komponenten og props som blir eksportert fra Chakra i denne filen. Hvis det er flere komponenter og props i _index.tsx_; fjern kun de du har overskrevet.

<span style={{ color: "orange" }}>**_Tips:_**</span> _N√•r du skal bygge selve komponenten er det lurt √• benytte [komponent-dokumentasjonen
til Chakra ](https://chakra-ui.com/docs/components)._ _I de fleste tilfeller kan du kopiere eksempelkoden deres, og tilpasse/bygge
videre p√• denne._

{" "}

<KvibProvider>
  <Alert status="warning">
    <AlertIcon />
    Viktig at forwardRef brukes fra chakra-ui og ikke fra react.
  </Alert>
</KvibProvider>

### Style komponenten üé®

Under f√∏lger en beskrivelse av hvordan en komponent kan styles. Link-komponenten brukes som eksempel.

1.  G√• til `packages/react/src/theme/components`: lag en ny fil, link.ts. Her skal stylingen til Chakra overskrives med Kartverkets eget design.
2.  F√∏lg [guiden til Chakra p√• hvordan style en komponent](https://chakra-ui.com/docs/styled-system/component-style).
    Du trenger ikke gj√∏re steget som omhandler ‚ÄúextendTheme‚Äù, da dette allerde er satt opp, s√• lenge du benytter mappestrukturen som allerede er satt opp.
3.  Eksporter themet fra _link.ts_ i `packages/react/src/theme/components/index.ts`.

Enkelte ganger kan det v√¶re n√∏dvendig √• bygge styling av en komponent fra bunnen av, eksempelvis dersom komponenten ikke er del av Chakra UI, eller komponenten ikke har egen styling annet enn at den arver styling fra annen komponent.
Benytt `useStyleConfig` hooken n√•r komponenten defineres for √• konsumere denne typen styling. Se [hvordan bruke useStyleConfig](https://chakra-ui.com/docs/styled-system/component-style#usestyleconfig-api) for eksempel.
For at komponenten skal f√• en default-styling er det viktig √• sette _defaultProps_ i _.ts_-filen (ikke bare som default i komponenten i _.tsx-filen_).
IconButton er en komponent hvor useStyleConfig er benyttet, og under vises det hvordan _defaultProps_ settes, og hvordan useStyleConfig brukes i \*.tsx\*.

                ```jsx
                //packages/react/src/theme/components/iconButton.ts

                export const IconButtonTheme = defineStyleConfig({
                  baseStyle:{....},
                  sizes: {....},
                  variants: {...},
                  defaultProps: {
                    variant: "solid",
                    size: "md",
                    colorScheme: "green"},
                });
                ```

                ```jsx
                //packages/react/src/Button/IconButton.tsx

                export const IconButton = forwardRef<IconButtonProps, "button">(
                  ({ isDisabled, isLoading, ...props },ref) => {
                    const styles = useStyleConfig("IconButton", props);
                    return (
                      <ChakraIconButton
                        {...props}
                        ref={ref}
                        __css={{ ...styles }}
                        isDisabled={isDisabled || isLoading}
                        aria-busy={isLoading}
                        icon={IconSpinner({ isLoading, ...props })}
                      ></ChakraIconButton>
                      );}
                );

                ```

<span style={{ color: "orange" }}>**_Tips:_**</span> _Chakra lenker til sin egen styling-kode for de fleste komponentene.For
eksempel kan stylingen av Button-komponenten sees ved √• trykke p√• ‚ÄúTheme source‚Äù √∏verst p√• [Chakra sin dokumentasjonsside
av Button](https://chakra-ui.com/docs/components/button/usage)._ _Mye av deres kode kan gjenbrukes ved √• bytte ut med egne
CSS-variabler._ _P√• denne m√•ten kan man ogs√• se om komponenten arver fra andre, eksempelvis vil theme-source for IconButton
lenkes til theming for Button, alts√• bruker de samme theming._

### Dokumentere komponenten üìù

Under f√∏lger en beskrivelse av hvordan en komponent skal dokumenteres. Link-komponenten brukes som eksempel.

1.  G√• til `apps/storybook/stories/components/link` og lag filen: _Link.stories.tsx_. I denne filen skal du lage stories for komponenten, og i _.mdx_-filen (som ligger i denne mappen fra f√∏r av) skrives dokumentasjonen.
2.  I _Link.stories.tsx_ sett f√∏lgende √∏verst i filen:

````jsx
import { Meta, StoryObj } from "@storybook/react";

const meta: Meta<typeof KvibLink> = {
  title: "Komponenter/Link<3 ",
  component: KvibLink,
  parameters: {
    docs: {
      story: { inline: true },
      canvas: { sourceState: "shown" },
    },
  },
  argTypes: {
    isExternal: {
      description: "If true, a icon will be included.",
      table: {
        type: { summary: Boolean },
        defaultValue: { summary: false },
      },
      control: "boolean",
    },
  },
};
    ```

- `title` setter filstrukturen p√• selve [dokumentasjonssiden til Designbiblioteket](https://kartverket.github.io/kvib/storybook).
- Hvis man √∏nsker √• endre p√• sortertingen av filstrukturen p√• Storybook, g√• til `apps/storybook/.storybook/preview.js`, og tilpass `order` som overskriver den ellers alfabetiske rekkef√∏lgen.

3.  P√• selve dokumentasjonssiden er det en _control-tabell_ som benyttes for √• teste ulike props-verdier p√• komponenten.
Beskrivelsen og default-verdien av egendefinerte props legges til som kommentar i _.tsx_-filen hvor propsene blir definert, alts√• i `packages/react/src/link/Link.tsx`.
Videre generer Storybook control-tabellen automatisk. Under er eksempel p√• beskrivelse av propen `variant`.

     ```jsx
    //packages/react/src/link/Link.tsx.

    export type LinkProps = Omit<ChakraLinkProps, "variant"> & {

      /**The colorvariant of the link.
      @default green*/
      variant: "green" | "blue";
    };

    ```

4.  I `apps/storybook/stories/components/link/Link.stories.tsx` skal du videre definere stories for √• vise komponenten med ulike props-verdier. Lag √©n story som viser default-verdiene til komponenten.
Dvs. benytt bare de n√∏dvendige propsa n√•r du definerer komponenten slik at default-verdiene vises.
Derav vil tilh√∏rende kodesnutt vise minstekravet for at denne komponenten skal fungere. Under vises Link.

```jsx
export default meta;
type Story = StoryObj<typeof KvibLink>;

export const Link: Story = {
  args: {
    children: "Dette er en lenke",
    href: "/?path=/docs/introduksjon--docs",
  },
  render: (args) => <KvibLink {...args}>{args.children}</KvibLink>,
};
    ```

Slik vil storyen se ut i dokumentasjonen, og vil vise den minimale koden en bruker trenger √• skrive.

<img alt="example of codesnippet" src={require("../../public/assets/deafultCompDocs.png")} width="700px"/>

5.  Lag videre stories som viser verdier for de ulike propsa, f.eks. size, variant, colorScheme, states (loading, disabled,‚Ä¶).
Velg de som er mest hensiktsmessig for komponenten. Bruk _HStack/VStack_ til √• ordne flere komponenter ved siden av hverandre i en story, hvor du tilordner hver komponent forksjellige verdier.
Dette tydeliggj√∏r forskjellen samtidig som det gir en oversiktlig dokumentasjon. Under er det vist eksempel hvor ulike states (internal og external link) vises

    ```jsx
    export const LinkStates: Story = {
      args: { colorScheme: "blue" },
      render: (args) => (
        <VStack>
          <KvibLink href="/?path=/docs/introduksjon--docs" {...args}>
            Dette er en intern lenke
          </KvibLink>
          <KvibLink isExternal href="https://chakra-ui.com/docs/components" {...args}>
            Dette er en ekstern lenke
          </KvibLink>
        </VStack>
      ),
    };
    ```

6.  I `apps/storybook/stories/components/link/Link.mdx`:

- √òverst i filen; bytt ut <Meta/> med: (N√• som du har definert en .stories.tsx fil settes tittelen her og ikke i .mdx)

```jsx
import * as LinkStories from "./Link.stories";

<Meta of={LinkStories} />;
      ```

- Gi en beskrivelse av komponenten og hvordan den skal brukes. **Sjekk rettskriving og klarspr√•k**.
- Etter ‚ÄúTa i bruk‚Äù, sett inn den storyen som er default ( Her; Link), og sett inn controll-tabellen til denne storyen:

```jsx
## Props

<Canvas of={LinkStories.Link} />         //henter selve storien (default-komponenten)

<Controls of={LinkStories.Link} />       //henter control- tabellen

      ```

- Sett inn de resterende storiesene med tilh√∏rende titler (##).

```jsx
## States (intern og ekstern link)

<Canvas of={LinkStories.LinkStates} />

## Farger

<Canvas of={LinkStories.LinkColorscheme} />

      ```

7.  Dersom du skal sette inn komponenter i dokumentasjon som er fra selve designbibliotek (eksempelvis Alert), s√• m√• komponenten wrappes inn i en `<KvibProvider/>`, slik som vist under:

```jsx
import { Alert, AlertIcon } from "@kvib/react";
import { KvibProvider } from "@kvib/react/src/provider/KvibProvider";

<KvibProvider>
  <Alert status="info">
    <AlertIcon />
    <AlertDescription>Husk √• oppdatere npm-pakken og changelog f√∏r du merger.</AlertDescription>
  </Alert>
</KvibProvider>;
````

<br />

üèÅ **N√• kan du kj√∏re `npm run dev` for √• se Storybook-dokumentasjonssiden lokalt. Videre m√• du gj√∏re ulike tester for √• sjekke at alt stemmer.**

<KvibProvider>
  <Alert status="info">
    <AlertIcon />
    Husk √• oppdatere npm-pakken og changelog f√∏r du merger.
  </Alert>
</KvibProvider>

<br />
## Testing av komponenten

### Teste at komponenten bygges riktig i npm-pakken üì¶

Det er en god standard √• teste @kvib/react-pakka f√∏r release. Her er en kort oppskrift til hvordan du kan teste npm-pakken p√• din lokale maskin f√∏r du opprettet PR og releaser.

1. Sett opp et prosjekt lokalt p√• maskinen din. Bruk for eksempel guidelines create-react-app, og sett eksempelvis opp et prosjekt under `~/Prosjekter/test-kvib-app`.

2. St√• i `kvib/packages/react` i den branchen du √∏nsker √• teste, og kj√∏r `npm run build`. Deretter kj√∏r `npm pack --pack-destination <path til prosjektet der du √∏nsker √• teste pakken>` . Det vil n√• dukke opp en pakke med navnet `kvib-react-0.x.0.tgz` p√• rot i test-prosjektet ditt.

3. I testprosjektet ditt i _package.json_ legg til denne linja under dependency: `"@kvib/react": "./kvib-react-0.x.0.tgz"`. Husk √• oppdater versjonen s√• det stemmer overens med filnavnet p√• kvib-pakken

4. I test-proskejektet ditt. Kj√∏r `npm install` eller `npm update` avhengig av om det f√∏rste gang eller f√∏lgende gang du legger til en kvib-pakke.

Kj√∏r opp testappen din, wrap appen i `<KvibProvider/>` ogs√• er det bare √• importere og sette i gang √• teste komponenter!

Fin artikkel om akkurat dette: [Use npm pack to test your packages locally](https://dev.to/scooperdev/use-npm-pack-to-test-your-packages-locally-486e)

### UU-testing av komponenten üîç

For √• s√∏rge for at komponentene vi lager overholder krav til universell utforming, m√• de testes for accessibility.
Designerne v√•re tenker p√• UU n√•r en komponenent blir designet, og Chakra tilbyr accessibility-features, blant annet A11y. Likevel har vi noen manuelle tester for komponenten f√∏r den havner i designsystemet.

1. **Skjermleser**:Test hvordan komponenten oppf√∏rer seg med skjermleser, eksmepelvis NVDA. Det er s√¶rlig viktig at tab-navigering fungerer korrekt.
2. **Zoom og skjermst√∏rrelse**:Teste med 400% zoom p√• desktop, samt teste p√• sm√• skjermer. I storybook er det en egen funksjon som gj√∏r at en kan teste hvordan komponenten ville sett ut p√• liten skjerm.
3. **a11y-synsnedsettelse**:I hver story kan det gjennomf√∏res accessibility-tester for synet. Den finner du i menyen p√• toppen, merket med et accessibility-symbol. Test de ulike versjonene (Blurred vision, deutoranomaly, osv.) for √• se om det er mulig √• lese og forst√• hva komponenten gj√∏r.

<img alt="navBar in story" src={require("../../public/assets/navBarStory.png")} width="500px" />

<br />

4. **a11y-andre UU-tester**: I en story/komponent p√• dokumentasjonssiden er det en accessibility-fane, hvor det kontinuerlig og automatisk blir testet for accessibility gjennom a11y.
   Ved √• klikke p√• fanen, f√•r du en oversikt over testene som er gjort; b√•de de godkjente og de som har brudd p√• krav. Alle testene m√• godkjennes f√∏r en komponent kan bli lagt til i designsystemet.
   {" "}

<img alt="accessibility-test tab " src={require("../../public/assets/tabsNavBarStory.png")} width="500px" />

5. **Test Runner**:Storybook sin Test Runner sjekker om storyene kj√∏rer uten feil, og er derav ikke en direkte UU-test.
   Likevel er a11y konfigurert sammen med denne testen slik at det kj√∏res som tester i Github Actions.
   Alle tester m√• derav godkjennes f√∏r det er tillatt √• merge til master. Dersom du √∏nsker √• kj√∏re test runner lokalt, √•pne termninalen og naviger til mappen `apps/storybook` og kj√∏r her `npm run dev` for √• kj√∏re storybook.
   Videre mens storybook kj√∏rer, √•pne en ny terminal, naviger til samme mappe og kj√∏r `npm run test-storybook`. Testene vil da vises i terminalen.

6. Her er noen nyttige lenker som inneholder sjekklister for UU-testing av den spesifikke komponenten:
   - [https://www.magentaa11y.com/web/](https://www.magentaa11y.com/web/)
   - [https://a11y-101.com/development](https://a11y-101.com/development)
   - [https://www.a11yproject.com/checklist/#appearance](https://www.a11yproject.com/checklist/#appearance)

<KvibProvider>
  <Alert status="info">
    <AlertIcon />
    Det kan v√¶re enkelte tilfeller hvor ally-testene feiler p√• grunn av noe underliggende i Chakra. Det er mulig √• overkj√∏re
    reglene og testingen til a11y, men dette skal kun gj√∏res dersom du ikke f√•r endret det p√• noen annen m√•te. F√∏lg [guiden
    til Storybook p√• hvordan konfigurere a11y](https://storybook.js.org/docs/react/writing-tests/accessibility-testing#configure).
  </Alert>
</KvibProvider>

## Oppdatere npm-pakken og changelog

N√•r komponenten er testet b√•de for oppf√∏rsel og UU, kan den merges med master, og legges til i npm-pakken.
Det er viktig √• ha en god changelog for at brukere enkelt skal kunne se om endringer av pakken p√•virker komponenter de eventuelt har tatt i bruk i egne prosjekt.

Under f√∏lger noen kjennetegn for versjonsoppdatering: (Informasjonen er hentet fra [Major.Minor.Patch artikkelen](https://medium.com/fiverr-engineering/major-minor-patch-a5298e2e1798))

- **patch**: ved interne fixes, eksempelvis bug fix, forbedrelse av performance, enviroment eller andre interne tweaks. Hovedregel: Bruker _burde_ oppdatere pakken uten √• n√∏le.
- **minor**: n√•r interfacet endrer seg, men har **mulighet** til √• rulle tilbake til tidligere versjoner. Eksempelvis ved nye funksjoner, komponenter, nye tilgjengelige props osv.
  Hovedregel: Bruker oppdaterer pakke for √• f√• nye funksjoner, uten at noe vil kr√¶sje.
- **major**: n√•r interfacet endrer seg, men har **ikke mulighet** til √• rulle tilbake til tidligere versjoner. Eksempelvis endrer API endpoint navn eller signatur.
  Hovedregel: test systemet n√∏ye etter oppdatering.

Slik gj√∏r du det:

1.  Kj√∏r `npx changeset`. Det vil komme opp valg du m√• gj√∏re i terminal for √• velge versjon-oppdatering av npm-pakken.
2.  Bruk piltaster og space til √• velge @kvib/react, som er den pakken vi √∏nsker √• oppdatere (gr√∏nn stjerne viser at den er valgt). Trykk deretter enter for √• komme videre.

<img alt="changeset- set package to include" src={require("../../public/assets/changeset1.png")} />

3.  Du f√•r videre valget om oppdateringen skal v√¶re av typen _major_. Hvis ja- bruk piltaster og enter til √• velge riktig pakke. Hvis nei- trykk enter med engang uten √• velge pakke.
    <img alt="changeset- set major bump" src={require("../../public/assets/changeset2.png")} />
4.  Videre setter du oppdatering av typen minor. Bruk piltaster og enter til √• velge riktig pakke.
    <img alt="changeset- set minor bump" src={require("../../public/assets/changeset3.png")} />
5.  Tilslutt skriver du oppsummering av oppdateringen som er gjort av pakken.
    <img alt="changeset- set summary" src={require("../../public/assets/changeset4.png")} />
6.  I mappen _changeset_ vil det n√• automatisk legges til en fil med et tilfeldig generert navn. Der kan du redigere _summary_ som du skrev av oppdateringen.
    Det er s√¶rlig viktig at kritiske endringer blir dokumentert, f.eks. dersom gyldig verdier til en prop endres. Under er et eksempel p√• changelog av Button-komponenten:

        ```jsx

        Button-komponent er tilgjengelig med Kartverkets Design. Dokumentasjon er oppdatert. Kritiske endringer:
         -**colorScheme** tar verdiene: "green" (default), "blue", "gray", "red".
         -**rightIcon**/ **leftIcon**: er av typen String, ikke lenger et element.

    ```

    ```
